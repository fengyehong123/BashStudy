#!/usr/bin/env bash

# 后台任务的最大数量
MAX_JOBS=3

for i in {1..10}; do

    # 在后台执行耗时任务
    (
        echo "开始任务 $i"
        sleep $((RANDOM % 5))
        echo "完成任务 $i"
    ) &

    # ___________________________________________
    # 控制并行数量
    #   -p → 只显示作业的 PID。
    #   -r → 只显示正在运行的作业。
    # ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
    if [[ $(jobs -r -p | wc -l) -ge $MAX_JOBS ]]; then
        # ___________________________________________
        # wait -n (Bash 4.3+)：
        #   等待任意一个后台任务 完成，非常适合并发控制。
        # ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
        wait -n   
    fi

done

# 等待全部的任务完成
wait
echo "全部完成 ✅"